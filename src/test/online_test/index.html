<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Manchester Baby Simulator - Cheerpj Test</title>
    <script src="https://cjrtnc.leaningtech.com/3.0/cj3loader.js"></script>
    <link rel="icon" href="/classes/icons/baby.png">
</head>
<body>


<div>
    
<script>
    // define the javascript functions to be called from the Java application running on the CheerpJ JVM in the browser

    async function openFileInSimulator(fileName) {
        console.log("File name received in javascript still:", fileName);
        
        // opens file in simulator
        const response = await window.myApplication.openFile(fileName);
    }

    // Function to programmatically open file dialog and handle selection
    // Receives call from Java to trigger it
    async function Java_com_ccs_baby_utils_CheerpJUtils_getFileForSimulator() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.asm,.snp';
        input.style.display = 'none';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;

                // just copy the filename into the simulator's sandbox filesystem in /str/ which is much simpler
                cheerpOSAddStringFile("/str/" + file.name, content);

                // and now the file is available in the simulator to be opened
                openFileInSimulator("/str/" + file.name);
            };

            reader.onerror = function() {
                console.error(`Error reading file "${file.name}"`);
            };

            reader.readAsText(file);
            document.body.removeChild(input);
        };

        document.body.appendChild(input);
        input.click();
    }

    // Assigns the Java application instance to window.myApplication.
    // Ensures continuous access by preventing the function from returning.
    async function Java_com_ccs_baby_utils_CheerpJUtils_nativeSetApplication(
        lib,
        myApplication
    ) {
        window.myApplication = myApplication;
        console.log("Java application instance set on JavaScript side.");
        return new Promise(() => {}); // Keeps the function from returning
    }

</script>

<script>
    (async function () {
        await cheerpjInit({
            licenseKey:"v1-78XJpCYyasiWIQVMqUfwXea3tVk=", // license key from leaning technologies ltd, only for use on https://davidsharp.com/baby/online
            clipboardMode: "system",
            natives: {
                Java_com_ccs_baby_utils_CheerpJUtils_getFileForSimulator,
                Java_com_ccs_baby_utils_CheerpJUtils_nativeSetApplication
            }
        });
        // set cheerpj size to be the same size as the window in Baby.java
        cheerpjCreateDisplay(700, 950);
        await cheerpjRunJar("/app/baby-3.0.0.jar");
    })();
</script>
</div>



</body>
</html>
